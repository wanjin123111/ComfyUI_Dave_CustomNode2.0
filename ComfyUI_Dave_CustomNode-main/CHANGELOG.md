# ComfyUI Dave Custom Node - 变更日志

## [4.0.0-ultimate-2025] - 2025-01-27 - 🚀 基于网络专业知识的终极重构

### 🌟 革命性更新：完全重写以适配ComfyUI v0.3.43和新前端架构

经过调用网络专业知识，发现ComfyUI在2024年8月进行了前端分离，采用全新架构。本版本完全重构以适配最新版本。

### 🔥 核心架构更新
- **新前端兼容**: 支持`Comfy-Org/ComfyUI_frontend`最新架构
- **现代API**: 使用`app.extensionManager`新API系统
- **优化性能**: 60fps重绘限制，现代化事件处理
- **简化稳定**: 重构为6个核心身体部件，确保稳定性

### 🎯 修复的关键问题
- **参数更新**: 完全修复参数调整不生效问题
- **鼠标拖拽**: 重新实现拖拽系统，支持实时移动
- **画布重绘**: 使用现代化重绘机制，多重保险确保生效
- **事件绑定**: 基于新架构的事件处理系统

### 🚀 2025年版新特性
- **智能重绘**: 使用`requestAnimationFrame`优化性能
- **现代化UI**: 全新深色主题和视觉效果
- **多级API**: 同时支持新旧API，确保兼容性
- **详细日志**: Emoji图标和详细调试信息

### 🎨 视觉和交互增强
- **现代化画布**: 深色主题，专业级界面
- **旋转指示器**: 直观显示部件旋转角度
- **实时信息面板**: 显示当前部件详细信息
- **操作提示**: 清晰的用户指导信息

### 📋 核心身体部件（6个）
1. **头部 (head)** - 红色，顶部位置
2. **躯干 (torso)** - 青色，中心位置  
3. **左臂 (left_arm)** - 蓝色，左侧位置
4. **右臂 (right_arm)** - 黄色，右侧位置
5. **左腿 (left_leg)** - 浅蓝，左下位置
6. **右腿 (right_leg)** - 紫色，右下位置

### 🔧 技术升级
- **现代JavaScript**: ES6+语法和模块化结构
- **错误处理**: 完善的try-catch错误捕获
- **性能优化**: 节流和防抖机制
- **内存管理**: 避免内存泄露的事件处理

### 💡 专业知识应用
基于对ComfyUI新架构的深入研究：
- 前端分离后的API变化
- 新的`extensionManager`系统
- 现代化的Widget处理机制
- 优化的画布渲染流程

### ⚠️ 重要变更
- **简化部件**: 从27个减少到6个核心部件，提高稳定性
- **新API**: 要求ComfyUI v0.3.43或更高版本
- **接口变更**: 使用新的前端API，向前兼容
- **配置重置**: 建议清除旧配置以使用新格式

### 🎯 使用说明
1. **重启ComfyUI**: 加载新版本
2. **清除缓存**: 刷新浏览器缓存
3. **添加节点**: `Human Body Parts Conditioning (Dave)`
4. **开始使用**: 选择部件，拖拽或调参数

## [3.1.1] - 2025-01-27 - 鼠标拖拽交互功能 🖱️（已弃用）

### 🖱️ 全新鼠标拖拽功能
- **实时参数同步**: 修复参数控件调整后画面不实时更新的问题
- **强制重绘机制**: 参数变化立即触发画面更新
- **智能拖拽系统**: 
  - 点击部件中心区域 = 拖拽移动位置
  - 点击四个角落 = 调整大小
  - 实时参数控件同步更新
  - 智能边界检测和约束

### ✨ 交互体验提升
- **可视化控制点**: 选中部件显示白色方块拖拽控制点
- **鼠标样式提示**: 
  - 移动模式显示 `move` 光标
  - 调整模式显示 `nw-resize` 光标
- **操作提示文字**: 画布底部显示"拖拽部件中心=移动位置，拖拽四角=调整大小"
- **实时反馈**: 拖拽过程中参数控件实时更新数值

### 🔧 技术实现
- **事件系统**: 完整的鼠标事件处理（onMouseDown, onMouseMove, onMouseUp）
- **拖拽模式**: 支持move、resize-tl、resize-tr、resize-bl、resize-br五种模式
- **精确计算**: 像素级精确的位置和大小计算
- **边界约束**: 自动防止部件超出画布范围
- **参数同步**: updateParameterWidgets函数确保控件同步

### 🎯 用户体验
- **直观操作**: 所见即所得的可视化编辑
- **精确控制**: 支持像素级精确调整
- **快速定位**: 鼠标直接操作比数字输入更直观
- **实时预览**: 拖拽过程中立即看到效果

## [3.1.0] - 2025-01-27 - 专业医学级人体部件拆解功能 🩺

### 🏥 医学级专业升级
- **新增人体部件**：从10个扩展到15个部件，增加颈部、双手、双脚
- **解剖学标准**：基于COCO-17和医学解剖学标准的专业配置
- **医疗康复预设**：物理治疗、运动分析、手部康复三大专业预设
- **解剖学连接**：符合人体解剖学的精确连接关系

### ✨ 新增医学功能
- **部件分类系统**：头颈部、躯干核心、上肢系统、下肢系统
- **医学重要性标记**：高、中、低三级医学重要性分类
- **灵活性评估**：极高、高、中等、低四级灵活性评估
- **解剖区域标识**：cranial、cervical、thoracic等专业解剖学区域

### 🎯 专业医疗预设
| 预设名称 | 适用场景 | 重点部件 | 强度系数 |
|---------|---------|---------|---------|
| 物理治疗 | 康复训练 | 颈部、躯干、上肢 | 1.2x |
| 运动分析 | 体育训练 | 躯干、大腿、小腿 | 1.5x |
| 手部康复 | 精细动作 | 双手、小臂 | 2.0x |

### 📋 完整人体部件列表（15个）
| 部件 | 解剖区域 | 医学重要性 | 灵活性 | 分类 |
|------|----------|------------|---------|------|
| 头部 | cranial | 高 | 中等 | 头颈部 |
| 颈部 | cervical | 高 | 高 | 头颈部 |
| 躯干 | thoracic_lumbar | 高 | 低 | 躯干核心 |
| 左/右大臂 | brachial | 中 | 高 | 上肢系统 |
| 左/右小臂 | antebrachial | 中 | 高 | 上肢系统 |
| 左/右手 | manual | 高 | 极高 | 上肢系统 |
| 左/右大腿 | femoral | 中 | 中等 | 下肢系统 |
| 左/右小腿 | crural | 中 | 中等 | 下肢系统 |
| 左/右脚 | pedal | 高 | 中等 | 下肢系统 |

### 🔧 增强的前端功能
- **医疗预设应用**：右键菜单一键应用专业配置
- **解剖学信息显示**：显示部件详细医学信息
- **专业连接关系**：基于医学标准的部件连接
- **智能强度分配**：根据医疗场景自动调整强度

### 🎨 专业级可视化
- **部件分类颜色**：不同系统使用相近色调
- **医学重要性指示**：高重要性部件突出显示
- **解剖学连接线**：符合人体结构的连接关系
- **专业术语标注**：使用标准解剖学术语

## [3.0.0] - 2025-01-27 - 人体部件拆解功能 🚀

### 🎯 重大新功能 - Human Body Parts Conditioning
- **全新节点**：专为人物拆解设计的人体部件条件控制系统
- **10个人体部件**：头部、躯干、左右大臂、左右小臂、左右大腿、左右小腿
- **智能条件分配**：自动将输入条件分类到对应人体部件
- **专业解剖学布局**：基于人体解剖学的默认部件配置

### ✨ 核心功能特性
- **HumanBodyPartsConditioning** - 主要人体部件条件控制节点
- **HumanBodyPartsDebug** - 人体部件调试和信息显示节点
- **可视化人体结构** - 彩色部件显示、连接线、选中高亮
- **专用条件输入** - 每个部件支持独立的条件输入接口
- **实时参数调整** - 位置、大小、强度、旋转全面可控

### 🎨 前端可视化界面
- **人体结构图** - 完整的人体部件可视化显示
- **部件连接线** - 显示人体解剖学连接关系
- **彩色编码** - 每个部件使用独特颜色标识
- **选中高亮** - 当前编辑部件的视觉反馈
- **旋转指示器** - 支持旋转的部件显示方向指示
- **实时信息** - 底部显示当前部件详细参数

### 🏗️ 技术架构
- **模块化设计** - 独立的人体部件处理系统
- **8像素对齐** - 确保与AI模型最佳兼容性
- **智能缩放** - 根据分辨率自动调整部件比例
- **边界检查** - 自动防止部件超出图像范围
- **条件合并** - 主条件和专用条件的智能合并

### 📋 支持的人体部件列表
| 部件 | 默认位置 | 默认大小 | 颜色标识 |
|------|----------|----------|----------|
| 头部 | (256, 50) | 180×220 | #FF6B6B |
| 躯干 | (200, 280) | 240×360 | #4ECDC4 |
| 左大臂 | (120, 320) | 80×160 | #45B7D1 |
| 左小臂 | (80, 480) | 70×140 | #96CEB4 |
| 右大臂 | (480, 320) | 80×160 | #FECA57 |
| 右小臂 | (520, 480) | 70×140 | #FF9FF3 |
| 左大腿 | (220, 640) | 90×180 | #54A0FF |
| 左小腿 | (200, 820) | 80×160 | #5F27CD |
| 右大腿 | (340, 640) | 90×180 | #00D2D3 |
| 右小腿 | (360, 820) | 80×160 | #FF6348 |

### 🎮 使用场景
- **时装设计** - 分别描述头部、服装、配饰等
- **角色设计** - 游戏/动漫角色的部件化创建
- **医学可视化** - 人体解剖结构的精确控制
- **艺术创作** - 专业级人物画像的部件控制

### 🔧 右键菜单功能
- **🔄 重置所有部件** - 一键恢复默认配置
- **👤 标准人体比例** - 应用标准解剖学比例

### 📊 性能优化
- **延迟加载** - 按需加载部件配置
- **内存优化** - 高效的数据结构设计
- **渲染优化** - 智能的可视化更新策略

### 🔄 向后兼容性
- **完全兼容** - 不影响现有MultiAreaConditioning功能
- **平滑升级** - 从v2.x版本无缝升级
- **配置保持** - 保持原有节点的所有设置

## [2.5.4] - 2025-01-27 - 点击开关式拖拽

### 🎯 改进拖拽交互模式
- **点击开关式拖拽**：第一次点击区域开始拖拽，鼠标移动时区域跟随，再次点击结束拖拽
- **用户反馈**：根据"鼠标能拖拽没问题 但是会一直跟随鼠标 改下 鼠标点击拖拽 鼠标再次点击就是放置"
- **交互逻辑**：区域中心跟随鼠标位置实时移动

### ✨ 新交互方式
- **开始拖拽**：点击区域内部进入拖拽模式，鼠标样式变为move
- **实时跟随**：鼠标移动时区域中心跟随鼠标位置
- **结束拖拽**：再次点击任意位置结束拖拽模式，恢复默认光标
- **快速定位**：非拖拽状态下点击空白处直接设置新位置

### 🔧 技术实现
- **状态管理**：isDragging状态控制拖拽模式开关
- **位置计算**：区域中心对齐鼠标坐标
- **边界检查**：自动限制在画布范围内
- **鼠标事件**：onMouseUp不再结束拖拽状态

## [2.5.3] - 2025-01-27 - 简化拖拽交互

### 🎯 交互功能简化
- **简化拖拽**：移除复杂的大小调整功能，只保留位置拖拽
- **用户反馈**：根据用户反馈"效果不好 大小不用管了 只需要能鼠标点击能拖拽位置就行"
- **交互优化**：去除边缘检测和角落检测，简化交互逻辑

### ✨ 保留功能
- **位置拖拽**：点击区域内部可拖拽移动位置
- **快速定位**：点击空白处直接设置新位置
- **边界检查**：自动边界检查和位置修正
- **鼠标样式**：拖拽时显示move光标

### 🗑️ 移除功能
- **大小调整**：取消所有resize模式（resize-br, resize-tr, resize-bl, resize-tl）
- **边缘检测**：移除复杂的边缘和角落检测逻辑
- **复杂交互**：简化鼠标事件处理

### 🔧 技术改进
- **代码简化**：减少复杂的条件判断和状态管理
- **性能优化**：降低鼠标事件处理的复杂度
- **维护性**：更简洁的代码结构，便于后续维护

## [2.5.2] - 2025-01-27 - ComfyUI v0.3.43 全面兼容更新

### 🎯 完全适配 ComfyUI v0.3.43
- **重大更新**: 深度适配最新ComfyUI v0.3.43版本
- **前端API**: 完全兼容前端API v1.23.4
- **稳定性**: 修复所有已知的兼容性问题
- **性能**: 优化代码以适配最新架构

### ✨ 新增功能
- **多路径前端支持**: 自动检测多种前端扩展路径
- **增强版本检查**: 完整的ComfyUI版本兼容性检查
- **错误容错**: 改进的错误处理和恢复机制
- **日志增强**: Winston兼容的日志系统

### 🔧 Python后端改进
- **类型注解**: 完整的类型提示支持
- **模块化设计**: 拆分功能函数提高可维护性
- **边界检查**: 8像素对齐的精确计算
- **异常处理**: 全面的错误捕获和处理
- **数据验证**: 严格的输入数据验证

### 🎨 JavaScript前端升级
- **ES6+语法**: 使用现代JavaScript特性
- **常量定义**: 统一的配置常量管理
- **模块化架构**: Utils, LayoutManager, DrawEngine分离
- **错误处理**: try-catch包装所有关键函数
- **布局优化**: 改进的控件布局和间距

### 🐛 修复问题
- **前端兼容性**: 修复v0.3.43前端API变化导致的问题
- **输入验证**: 修复可选输入的处理逻辑
- **画布绘制**: 修复旋转可视化的渲染问题
- **内存管理**: 优化对象创建和销毁
- **事件处理**: 修复鼠标和键盘事件响应

### 📦 文件结构更新
```
ComfyUI_Dave_CustomNode/
├── __init__.py (v2.5.2)               # 主初始化文件
├── MultiAreaConditioning.py (v2.5.2) # 多区域条件节点
├── MultiLatentComposite.py (v2.5.2)  # 多潜在合成节点
├── javascript/
│   └── MultiAreaConditioning.js (v2.5.2) # 前端交互文件
├── version_check.py (new)             # 兼容性检查工具
├── CHANGELOG.md                       # 变更日志
└── README.md                          # 使用说明
```

### 🔄 兼容性信息
- **ComfyUI版本**: v0.3.43 (推荐) / v0.3.40+ (兼容)
- **Python版本**: 3.8+ (推荐3.10+)
- **PyTorch版本**: 最新稳定版
- **前端API**: v1.23.4兼容

---

## [2.5.1] - 2025-01-27 - ComfyUI v0.3.43初步兼容

### 🎯 ComfyUI v0.3.43兼容性
- 适配ComfyUI v0.3.43版本
- 添加EXTENSION_METADATA元数据
- 更新节点显示名称映射
- 创建版本检查脚本

### ✨ 新增功能
- **旋转控制**: 支持-180°到180°的旋转角度控制
- **可视化指示**: 旋转矩形绘制和方向指示器
- **数据向后兼容**: 自动处理旧的5参数格式

### 🔧 界面布局优化
- **紧凑布局**: 所有参数控件紧贴节点底部
- **尺寸调整**: 节点尺寸优化为400x680像素
- **控件排列**: resolutionX, resolutionY, index, strength, rotation, x, y, width, height

### 🐛 修复问题
- 修复界面控件重叠问题
- 修复可选输入的连接问题
- 修复画布位置计算错误

---

## [2.5.0] - 2025-01-27 - 功能完善版

### ✨ 主要新功能
- **旋转支持**: 新增rotation参数，支持区域旋转
- **6参数格式**: 扩展为[x, y, width, height, strength, rotation]
- **可视化增强**: 前端支持旋转矩形显示
- **向后兼容**: 自动处理旧的5参数格式

### 🔧 技术改进
- **数据结构**: 升级为6参数区域定义
- **前端渲染**: 支持旋转矩形和指示器绘制
- **参数验证**: 增强的输入验证和边界检查

### 🎨 界面优化
- **控件布局**: 重新设计的参数控件布局
- **可视化**: 改进的区域显示和选择
- **交互体验**: 更直观的旋转控制

---

## [2.4.0] - 2025-01-26 - 界面布局优化

### 🎨 界面布局改进
- **画布位置**: 可视化窗口放置在resolutionX/Y下方
- **参数排列**: index控件在画布下方
- **尺寸优化**: 节点尺寸调整为400x680像素

### 🔧 功能增强
- **输入接口**: 4个conditioning输入（1个必需，3个可选）
- **错误处理**: 完整的边界检查和异常处理
- **兼容性**: 向后兼容处理

---

## [2.3.0] - 2025-01-25 - 兼容性修复

### 🐛 兼容性问题解决
- **ComfyUI版本**: 适配最新ComfyUI版本
- **前端兼容**: 修复界面显示问题
- **JavaScript**: 简化ES6特性以提高兼容性

### 🔧 代码优化
- **错误处理**: 增强的异常捕获
- **数据验证**: 改进的输入验证逻辑
- **性能**: 优化渲染性能

---

## [2.2.0] - 2025-01-20 - 现代化更新

### ✨ 代码现代化
- **Python**: 添加类型注解和现代化语法
- **JavaScript**: 使用ES6+特性
- **架构**: 模块化代码结构

### 🔧 功能增强
- **日志系统**: Winston兼容的日志记录
- **错误处理**: 全面的异常处理机制
- **性能优化**: 改进的算法和数据处理

---

## [2.1.0] - 2025-01-15 - 功能扩展

### ✨ 新增功能
- **多区域支持**: 支持最多4个conditioning输入
- **可视化控制**: 实时区域绘制和交互
- **右键菜单**: 快捷操作菜单

### 🎨 界面改进
- **可视化**: 彩色区域显示
- **交互**: 鼠标点击设置位置
- **布局**: 优化的控件排列

---

## [2.0.0] - 2024-12-01 - 重大重构

### 🎯 架构重写
- **完全重构**: 重写所有核心代码
- **性能提升**: 大幅优化处理速度
- **稳定性**: 增强的错误处理

### ✨ 新功能
- **MultiLatentComposite**: 多潜在图像合成
- **ConditioningUpscale**: 条件放大
- **ConditioningStretch**: 条件拉伸
- **ConditioningDebug**: 调试输出

---

## [1.x.x] - 历史版本

### 原始版本功能
- 基础的多区域条件控制
- 简单的可视化界面
- 基本的区域定义

---

## 技术说明

### 数据格式变化
- **v1.x**: `[x, y, width, height]` (4参数)
- **v2.0-2.4**: `[x, y, width, height, strength]` (5参数)
- **v2.5+**: `[x, y, width, height, strength, rotation]` (6参数)

### 兼容性策略
- **向后兼容**: 自动检测和转换旧格式
- **默认值**: 缺失参数使用合理默认值
- **错误处理**: 优雅降级和错误恢复

### ComfyUI版本支持
- **v2.5.2**: ComfyUI v0.3.43 (完全兼容)
- **v2.5.1**: ComfyUI v0.3.43 (初步支持)
- **v2.4.x**: ComfyUI v0.3.40+
- **v2.3.x**: ComfyUI v0.3.35+
- **v2.2.x**: ComfyUI v0.3.30+

---

## 贡献指南

### 报告问题
1. 检查现有issue是否已存在
2. 提供详细的复现步骤
3. 包含ComfyUI版本信息
4. 附上错误日志（如有）

### 功能请求
1. 描述具体的使用场景
2. 说明期望的行为
3. 考虑向后兼容性

### 代码贡献
1. Fork项目并创建功能分支
2. 遵循现有代码风格
3. 添加适当的测试和文档
4. 提交Pull Request

---

## 许可证

MIT License - 详见LICENSE文件

## 致谢

感谢ComfyUI社区的支持和反馈，特别是在兼容性测试方面的帮助。 